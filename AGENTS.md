# PROJECT KNOWLEDGE BASE

**Generated:** 2026-01-20
**Commit:** 79f20fc
**Branch:** main

## OVERVIEW

Flux GitOps repository for K3s cluster on Fedora CoreOS. Manages selfhosted apps at `*.amajor.cloud` with automated TLS via cert-manager and Envoy Gateway ingress.

## STRUCTURE

```
selfhosted/
├── clusters/selfhosted/     # Flux sync manifests (dependency chain)
│   └── flux-system/         # DO NOT EDIT - auto-generated by Flux
├── apps/
│   ├── base/                # User-facing applications (7 apps)
│   ├── infra/               # Infrastructure (cert-manager, envoy, redis)
│   └── bootstrap-infra/     # Sealed-secrets (deployed first)
├── .github/workflows/       # Claude code review + interactive Claude
└── renovate.json            # Auto-updates (minor/patch auto-merge)
```

## WHERE TO LOOK

| Task | Location | Notes |
|------|----------|-------|
| Add new app | `apps/base/<name>/` | Copy existing app structure, add kustomization.yaml |
| Modify infrastructure | `apps/infra/` | cert-manager, envoy-gateway, redis, kwatch |
| Change Flux sync order | `clusters/selfhosted/*.yaml` | Dependency chain: bootstrap → cert-manager → infra → apps |
| Encrypted secrets | Use `kubeseal` | Sealed by controller in `sealed-secrets` namespace |
| TLS certificates | `apps/infra/cert-manager-config/` | DNS-01 via Porkbun webhook |
| Ingress routing | `apps/base/<app>/httproute.yaml` | Gateway API HTTPRoute (not Ingress) |

## CONVENTIONS

| Pattern | Rule |
|---------|------|
| Container images | **ALWAYS sha256 digest** (not tags) |
| Secrets | **SealedSecret only** - never plaintext |
| Git workflow | **Feature branch + PR** - never push to main |
| Ingress | Gateway API HTTPRoute (Envoy) - not nginx Ingress |
| Helm charts | **NEVER Bitnami** |
| Flux auto-gen | **DO NOT EDIT** `flux-system/gotk-*.yaml` |

## ANTI-PATTERNS (THIS PROJECT)

| NEVER | Why |
|-------|-----|
| Push directly to main | GitOps auto-deploys immediately |
| Use Bitnami Helm charts | Overly complex, doesn't fit project |
| Edit gotk-components.yaml | Auto-regenerated by Flux |
| Set `prune: true` on CRD Kustomizations | Deletes CRDs, breaks all dependent resources |
| Commit plaintext secrets | Use kubeseal with sealed-secrets controller |
| Use floating image tags | Must use `@sha256:...` for reproducibility |

## DEPENDENCY CHAIN

```
bootstrap-infra (sealed-secrets)
    ↓
cert-manager (health checks on 3 deployments)
    ↓
cert-manager-config (Porkbun DNS-01 webhook)
    ↓
gateway-api-crds → infra (redis, kwatch, flux-notifications)
    ↓
envoy-gateway
    ↓
apps (gatus, speedtest, hvcwatch, stockchartsalerts, stocknews, thetagang-notifications, flux-webhook)
```

## COMMANDS

```bash
# Kubeconfig
export KUBECONFIG=~/.kube/k3s-psychz-config

# Flux status
flux get kustomizations
flux get sources git

# Force reconciliation
flux reconcile kustomization apps

# Validate before commit
kubectl apply --dry-run=client -f apps/base/<app>/

# Seal a secret
kubectl create secret generic <name> --from-literal=key=value -n <ns> --dry-run=client -o yaml | \
  kubeseal --controller-name=sealed-secrets --controller-namespace=sealed-secrets --format=yaml

# Check certificates
kubectl get certificates -A

# Flux logs
flux logs --level=error
```

## NOTES

- **Kubeconfig**: `~/.kube/k3s-psychz-config` (NOT default ~/.kube/config)
- **Webhook**: GitHub push → `flux-webhook.amajor.cloud` → instant reconcile (vs 10min poll)
- **Renovate**: Auto-merges minor/patch after 3 days; majors need manual approval
- **Claude review**: All PRs get automated K8s/SRE review (except Renovate bot)
- **Migration**: Nginx → Envoy Gateway in progress (see ENVOY_MIGRATION_PLAN.md)
