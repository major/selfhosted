# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is a **Flux GitOps repository** for managing Kubernetes applications in a selfhosted cluster. Flux v2.7.1 continuously monitors this repository and automatically applies changes to the cluster.

## Architecture

### GitOps Structure

The repository follows Flux's standard GitOps pattern:

- **[clusters/selfhosted/](clusters/selfhosted/)** - Cluster-specific configuration
  - [flux-system/](clusters/selfhosted/flux-system/) - Flux core components and sync configuration (auto-generated by Flux)
  - [apps.yaml](clusters/selfhosted/apps.yaml) - Kustomization that points to `./apps/base` for application manifests

- **[apps/base/](apps/base/)** - Application manifests organized by application name
  - Each subdirectory represents a distinct application (e.g., `traefik/`, `whoami/`)
  - Applications are automatically deployed via the `apps` Kustomization

### Flux Sync Flow

1. Flux GitRepository watches the `main` branch at `ssh://git@github.com/major/selfhosted`
2. `flux-system` Kustomization syncs `./clusters/selfhosted` every 10 minutes
3. `apps` Kustomization syncs `./apps/base` every 10 minutes
4. Changes to any YAML files trigger automatic reconciliation

## Working with Applications

### Adding a New Application

1. Create a new directory under [apps/base/](apps/base/) with the application name
2. Add Kubernetes manifests (Deployment, Service, HelmRelease, etc.)
3. Flux will automatically detect and deploy the application within 10 minutes
4. To force immediate sync: `flux reconcile kustomization apps`

### Modifying Existing Applications

Edit manifests in the respective [apps/base/\<app-name\>/](apps/base/) directory. Changes are automatically applied on the next Flux sync interval.

### Testing Changes

```bash
# Check Flux reconciliation status
flux get kustomizations

# Force reconciliation without waiting
flux reconcile kustomization apps

# View application status
flux get helmreleases
flux get all -A

# Check for errors
flux logs --level=error
```

## Key Commands

### Flux Operations

```bash
# Check Flux system health
flux check

# View all Flux resources
flux get sources git
flux get kustomizations

# Suspend/resume reconciliation (useful during maintenance)
flux suspend kustomization apps
flux resume kustomization apps

# Force reconciliation
flux reconcile kustomization flux-system
flux reconcile kustomization apps
```

### Validation

```bash
# Validate Kubernetes manifests before committing
kubectl apply --dry-run=client -f apps/base/<app-name>/

# Validate with kustomize
kustomize build apps/base/
```

## Important Notes

- **DO NOT edit** [clusters/selfhosted/flux-system/gotk-components.yaml](clusters/selfhosted/flux-system/gotk-components.yaml) or [gotk-sync.yaml](clusters/selfhosted/flux-system/gotk-sync.yaml) - these are auto-generated by Flux
- Changes to the `main` branch are automatically applied to the cluster
- Renovate is configured to auto-merge dependency updates (see [renovate.json](renovate.json))
- The repository uses SSH authentication for Flux (secret: `flux-system` in `flux-system` namespace)
