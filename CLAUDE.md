# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is a **Flux GitOps repository** for managing Kubernetes applications in a selfhosted cluster. Flux v2.7.1 continuously monitors this repository and automatically applies changes to the cluster.

All applications are deployed under the **`*.amajor.cloud`** domain and use Traefik as the ingress controller with automatic TLS certificate management via cert-manager and Let's Encrypt (using Porkbun DNS challenge).

## Architecture

### GitOps Structure

The repository follows Flux's standard GitOps pattern:

- **[clusters/selfhosted/](clusters/selfhosted/)** - Cluster-specific configuration
  - [flux-system/](clusters/selfhosted/flux-system/) - Flux core components and sync configuration (auto-generated by Flux)
  - [apps.yaml](clusters/selfhosted/apps.yaml) - Kustomization that points to `./apps/base` for application manifests

- **[apps/base/](apps/base/)** - Application manifests organized by application name
  - Each subdirectory represents a distinct application (e.g., `traefik/`, `whoami/`, `uptime-kuma/`)
  - Applications are automatically deployed via the `apps` Kustomization
  - [cert-manager/](apps/base/cert-manager/) - Automatic TLS certificate management with Let's Encrypt
  - [flux-webhook/](apps/base/flux-webhook/) - GitHub webhook receiver for instant reconciliation
  - [sealed-secrets/](apps/base/sealed-secrets/) - Encrypted secrets management

### Flux Sync Flow

1. Flux GitRepository watches the `main` branch at `ssh://git@github.com/major/selfhosted`
2. `flux-system` Kustomization syncs `./clusters/selfhosted` every 10 minutes (or immediately via webhook)
3. `apps` Kustomization syncs `./apps/base` every 10 minutes (or immediately via webhook)
4. Changes to any YAML files trigger automatic reconciliation
5. **GitHub webhook** (configured at `flux-webhook.amajor.cloud`) triggers immediate reconciliation on push events

## Working with Applications

### Adding a New Application

1. Create a new directory under [apps/base/](apps/base/) with the application name
2. Add Kubernetes manifests (Deployment, Service, HelmRelease, etc.)
3. For web applications, create an IngressRoute with:
   - Host: `<app-name>.amajor.cloud`
   - Entry point: `websecure`
   - TLS: `tls: {}` (uses wildcard certificate automatically)
4. Commit and push changes
5. Changes are applied immediately via webhook, or within 10 minutes via polling
6. To force immediate sync: `flux reconcile kustomization apps`

### Modifying Existing Applications

Edit manifests in the respective [apps/base/\<app-name\>/](apps/base/) directory. Changes are automatically applied immediately (via webhook) or on the next Flux sync interval (polling).

### Testing Changes

```bash
# Check Flux reconciliation status
flux get kustomizations

# Force reconciliation without waiting
flux reconcile kustomization apps

# View application status
flux get helmreleases
flux get all -A

# Check for errors
flux logs --level=error
```

## Key Commands

### Flux Operations

```bash
# Check Flux system health
flux check

# View all Flux resources
flux get sources git
flux get kustomizations

# Suspend/resume reconciliation (useful during maintenance)
flux suspend kustomization apps
flux resume kustomization apps

# Force reconciliation
flux reconcile kustomization flux-system
flux reconcile kustomization apps
```

### Validation

```bash
# Validate Kubernetes manifests before committing
kubectl apply --dry-run=client -f apps/base/<app-name>/

# Validate with kustomize
kustomize build apps/base/
```

## TLS Certificate Management

TLS certificates are managed by **cert-manager** using Let's Encrypt with Porkbun DNS-01 challenge.

### Architecture

1. **cert-manager** ([apps/base/cert-manager/](apps/base/cert-manager/)) manages certificate lifecycle
2. **Wildcard Certificate** covers `amajor.cloud` and `*.amajor.cloud`
3. **Porkbun DNS Webhook** handles ACME DNS-01 challenges
4. **Automatic Renewal** occurs 30 days before expiry
5. **Traefik** uses the certificate as default for all HTTPS traffic

### Certificate Details

- **Certificate Name**: `amajor-cloud-wildcard` (in `traefik` namespace)
- **Secret Name**: `amajor-cloud-tls` (in `traefik` namespace)
- **Issuer**: Let's Encrypt Production via `letsencrypt-porkbun` ClusterIssuer
- **Domains**: `amajor.cloud`, `*.amajor.cloud`

### Verification Commands

```bash
# Check certificate status
kubectl -n traefik get certificate amajor-cloud-wildcard

# View certificate details
kubectl -n traefik describe certificate amajor-cloud-wildcard

# Check cert-manager logs
kubectl -n cert-manager logs -l app=cert-manager

# Verify TLS secret exists
kubectl -n traefik get secret amajor-cloud-tls
```

For more details, see [apps/base/cert-manager/README.md](apps/base/cert-manager/README.md).

## GitHub Webhook Integration

The repository is configured with GitHub webhooks for instant reconciliation instead of waiting for the 10-minute polling interval.

### Webhook Configuration
- **Endpoint**: `https://flux-webhook.amajor.cloud/hook/<receiver-id>`
- **Receiver**: [apps/base/flux-webhook/](apps/base/flux-webhook/)
- **Events**: Push events to `main` branch trigger immediate Flux reconciliation

For setup instructions and troubleshooting, see [apps/base/flux-webhook/README.md](apps/base/flux-webhook/README.md).

## Important Notes

- **DO NOT edit** [clusters/selfhosted/flux-system/gotk-components.yaml](clusters/selfhosted/flux-system/gotk-components.yaml) or [gotk-sync.yaml](clusters/selfhosted/flux-system/gotk-sync.yaml) - these are auto-generated by Flux
- Changes to the `main` branch are automatically applied to the cluster (immediately via webhook, or within 10 minutes via polling)
- Renovate is configured to auto-merge dependency updates (see [renovate.json](renovate.json))
- The repository uses SSH authentication for Flux (secret: `flux-system` in `flux-system` namespace)
- All applications use the `*.amajor.cloud` domain with Traefik IngressRoutes
- TLS certificates are managed by cert-manager using Let's Encrypt (Porkbun DNS challenge)
- Secrets are encrypted using Sealed Secrets before being committed to Git
