# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is a **Flux GitOps repository** for managing Kubernetes applications in a selfhosted cluster. Flux v2.7.1 continuously monitors this repository and automatically applies changes to the cluster.

All applications are deployed under the **`*.amajor.cloud`** domain and use Traefik as the ingress controller with automatic TLS certificate management via Traefik's native ACME DNS-01 challenge with Porkbun.

## Architecture

### GitOps Structure

The repository follows Flux's standard GitOps pattern:

- **[clusters/selfhosted/](clusters/selfhosted/)** - Cluster-specific configuration
  - [flux-system/](clusters/selfhosted/flux-system/) - Flux core components and sync configuration (auto-generated by Flux)
  - [bootstrap.yaml](clusters/selfhosted/bootstrap.yaml) - Kustomization for bootstrap infrastructure (sealed-secrets)
  - [infra.yaml](clusters/selfhosted/infra.yaml) - Kustomization for infrastructure apps (Traefik)
  - [apps.yaml](clusters/selfhosted/apps.yaml) - Kustomization for application manifests

- **[apps/bootstrap-infra/](apps/bootstrap-infra/)** - Bootstrap infrastructure components
  - [sealed-secrets/](apps/bootstrap-infra/sealed-secrets/) - Encrypted secrets management (deployed first)

- **[apps/infra/](apps/infra/)** - Infrastructure applications
  - [traefik/](apps/infra/traefik/) - Traefik ingress controller with ACME DNS-01 wildcard certificates

- **[apps/base/](apps/base/)** - Application manifests organized by application name
  - Each subdirectory represents a distinct application (e.g., `whoami/`, `uptime-kuma/`)
  - Applications are automatically deployed via the `apps` Kustomization
  - [flux-webhook/](apps/base/flux-webhook/) - GitHub webhook receiver for instant reconciliation

### Flux Sync Flow

1. Flux GitRepository watches the `main` branch at `ssh://git@github.com/major/selfhosted`
2. `flux-system` Kustomization syncs `./clusters/selfhosted` every 10 minutes (or immediately via webhook)
3. `bootstrap-infra` Kustomization syncs `./apps/bootstrap-infra` (sealed-secrets)
4. `infra` Kustomization syncs `./apps/infra` (Traefik) - depends on bootstrap-infra
5. `apps` Kustomization syncs `./apps/base` (applications) - depends on infra
6. Changes to any YAML files trigger automatic reconciliation
7. **GitHub webhook** (configured at `flux-webhook.amajor.cloud`) triggers immediate reconciliation on push events

## Working with Applications

### Adding a New Application

1. Create a new directory under [apps/base/](apps/base/) with the application name
2. Add Kubernetes manifests (Deployment, Service, PVC, etc.)
3. Create a `kustomization.yaml` file listing all resources
4. For web applications, create an IngressRoute with:
   - Host: `<app-name>.amajor.cloud`
   - Entry point: `websecure`
   - TLS: `certResolver: porkbun` with wildcard domains
5. Commit and push changes
6. Changes are applied immediately via webhook, or within 10 minutes via polling
7. To force immediate sync: `flux reconcile kustomization apps`

### Modifying Existing Applications

Edit manifests in the respective [apps/base/\<app-name\>/](apps/base/) directory. Changes are automatically applied immediately (via webhook) or on the next Flux sync interval (polling).

### Testing Changes

```bash
# Check Flux reconciliation status
flux get kustomizations

# Force reconciliation without waiting
flux reconcile kustomization apps

# View application status
flux get helmreleases
flux get all -A

# Check for errors
flux logs --level=error
```

## Key Commands

### Kubeconfig
- Use the kubeconfig at `~/.kube/k3s-config` for kubectl commands
- Set `KUBECONFIG=~/.kube/k3s-config` or use `--kubeconfig ~/.kube/k3s-config`

### Flux Operations

```bash
# Check Flux system health
flux check

# View all Flux resources
flux get sources git
flux get kustomizations

# Suspend/resume reconciliation (useful during maintenance)
flux suspend kustomization apps
flux resume kustomization apps

# Force reconciliation
flux reconcile kustomization flux-system
flux reconcile kustomization apps
```

### Validation

```bash
# Validate Kubernetes manifests before committing
kubectl --kubeconfig ~/.kube/k3s-config apply --dry-run=client -f apps/base/<app-name>/

# Validate with kustomize
kustomize build apps/base/
```

## TLS Certificate Management

TLS certificates are managed by **Traefik's native ACME integration** using Let's Encrypt with Porkbun DNS-01 challenge.

### Architecture

1. **Traefik** ([apps/infra/traefik/](apps/infra/traefik/)) handles certificate lifecycle via ACME
2. **Wildcard Certificate** covers `amajor.cloud` and `*.amajor.cloud`
3. **Porkbun DNS-01 Challenge** - Traefik uses Porkbun API for DNS validation
4. **Automatic Renewal** - Traefik renews certificates 30 days before expiry
5. **Persistent Storage** - Certificates stored in `/data/acme.json` on persistent volume

### Certificate Configuration

- **Resolver Name**: `porkbun` (configured in Traefik HelmRelease)
- **Certificate Storage**: `/data/acme.json` in Traefik pod
- **Email**: `major@mhtx.net`
- **Domains**: `amajor.cloud`, `*.amajor.cloud`
- **Challenge Type**: DNS-01 via Porkbun provider

### IngressRoute Configuration

All IngressRoutes use the Porkbun certificate resolver:

```yaml
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: example
  namespace: example
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`example.amajor.cloud`)
      kind: Rule
      services:
        - name: example
          port: 80
  tls:
    certResolver: porkbun
    domains:
      - main: amajor.cloud
        sans:
          - "*.amajor.cloud"
```

### Verification Commands

```bash
# Check Traefik pod status
kubectl --kubeconfig ~/.kube/k3s-config -n traefik get pods

# View Traefik logs for ACME activity
kubectl --kubeconfig ~/.kube/k3s-config -n traefik logs -l app.kubernetes.io/name=traefik -f

# Check ACME certificate storage
kubectl --kubeconfig ~/.kube/k3s-config -n traefik exec -it deployment/traefik -- ls -lh /data/acme.json
```

## GitHub Webhook Integration

The repository is configured with GitHub webhooks for instant reconciliation instead of waiting for the 10-minute polling interval.

### Webhook Configuration
- **Endpoint**: `https://flux-webhook.amajor.cloud/hook/<receiver-id>`
- **Receiver**: [apps/base/flux-webhook/](apps/base/flux-webhook/)
- **Events**: Push events to `main` branch trigger immediate Flux reconciliation

For setup instructions and troubleshooting, see [apps/base/flux-webhook/README.md](apps/base/flux-webhook/README.md).

## Important Notes

- **DO NOT edit** [clusters/selfhosted/flux-system/gotk-components.yaml](clusters/selfhosted/flux-system/gotk-components.yaml) or [gotk-sync.yaml](clusters/selfhosted/flux-system/gotk-sync.yaml) - these are auto-generated by Flux
- **DO NOT run git commands** (add, commit, push, pull, etc.) - the user will handle all git operations
- Changes to the `main` branch are automatically applied to the cluster (immediately via webhook, or within 10 minutes via polling)
- Renovate is configured to auto-merge dependency updates (see [renovate.json](renovate.json))
- The repository uses SSH authentication for Flux (secret: `flux-system` in `flux-system` namespace)
- All applications use the `*.amajor.cloud` domain with Traefik IngressRoutes
- TLS certificates are managed by Traefik's native ACME integration using Porkbun DNS-01 challenge
- Secrets are encrypted using Sealed Secrets before being committed to Git
- Traefik Helm chart version: v37.1.2 (uses `certificatesResolvers` and `redirections` syntax)

## Troubleshooting

### Sealed Secrets
If a SealedSecret fails to decrypt with "no key could decrypt secret", the sealed secret was encrypted with a different controller's key. Re-seal the secret:

```bash
# Get the current sealed-secrets controller public key and re-encrypt
kubectl --kubeconfig ~/.kube/k3s-config create secret generic <secret-name> \
  --from-literal=<key>=<value> \
  --namespace=<namespace> \
  --dry-run=client -o yaml | \
kubeseal --kubeconfig ~/.kube/k3s-config \
  --controller-name=sealed-secrets \
  --controller-namespace=sealed-secrets \
  --format=yaml > <output-file>.yaml
```

### Traefik Certificate Issues
Check Traefik logs for ACME challenge errors:
```bash
kubectl --kubeconfig ~/.kube/k3s-config -n traefik logs -l app.kubernetes.io/name=traefik --tail=100 | grep -i acme
```
