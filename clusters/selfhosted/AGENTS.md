# clusters/selfhosted

Flux Kustomization manifests controlling deployment order.

## KUSTOMIZATION ORDER

| Phase | File | Path | Depends On |
|-------|------|------|------------|
| 1 | bootstrap.yaml | apps/bootstrap-infra | - |
| 2 | cert-manager.yaml | apps/infra/cert-manager | bootstrap-infra |
| 3 | cert-manager-config.yaml | apps/infra/cert-manager-config | cert-manager |
| 4 | gateway-api-crds.yaml | apps/infra/gateway-api-crds | - |
| 5 | gateway-api-source.yaml | apps/infra/gateway-api-source | gateway-api-crds |
| 6 | infra.yaml | apps/infra | cert-manager-config |
| 7 | envoy-gateway.yaml | apps/infra/envoy-gateway | infra |
| 8 | apps.yaml | apps/base | infra |

## KUSTOMIZATION PATTERN

```yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: <name>
  namespace: flux-system
spec:
  interval: 10m
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./<path>
  prune: true           # Auto-cleanup (but NOT for CRDs!)
  wait: true            # Block until healthy (optional)
  timeout: 5m           # Health check timeout (optional)
  dependsOn:
    - name: <dependency>
```

## ADDING NEW LAYER

1. Create Kustomization YAML in this directory
2. Set `dependsOn` to prerequisite layer(s)
3. Use `wait: true` if downstream layers need it ready
4. Commit on feature branch

## DO NOT EDIT

```
flux-system/
├── gotk-components.yaml   # Auto-generated by flux bootstrap
├── gotk-sync.yaml         # Auto-generated by flux bootstrap
└── kustomization.yaml     # Lists the above
```

These files are regenerated by Flux. Manual edits will be overwritten.

## HEALTH CHECKS

cert-manager.yaml uses explicit health checks:
```yaml
spec:
  wait: true
  timeout: 5m
  healthChecks:
    - apiVersion: apps/v1
      kind: Deployment
      name: cert-manager
      namespace: cert-manager
```
