---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: thetagang-notifications
  namespace: thetagang
  labels:
    app: thetagang-notifications
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: thetagang-notifications
  template:
    metadata:
      labels:
        app: thetagang-notifications
    spec:
      containers:
        - name: thetagang-notifications
          image: ghcr.io/major/thetagang-notifications:main@sha256:20cc54f4397a3013c701b37d0b0f53e3d2678286eb5b5c1cdb78dd7f494e5415
          imagePullPolicy: Always
          securityContext:
            readOnlyRootFilesystem: true
          env:
            # üîê Sensitive credentials from SealedSecret
            - name: WEBHOOK_URL_TRADES
              valueFrom:
                secretKeyRef:
                  name: thetagang-secrets
                  key: webhook-url-trades
            - name: TRADES_API_KEY
              valueFrom:
                secretKeyRef:
                  name: thetagang-secrets
                  key: trades-api-key

            # ‚öôÔ∏è Application configuration
            - name: DAEMONIZE_TRADE_BOT
              value: "1"
            - name: PATRON_TRADES_ONLY
              value: "1"
            - name: STORAGE_DIR
              value: "/storage"
            - name: SKIPPED_USERS
              value: "antithetagang,jrue"

            # üîó Redis connection (cross-namespace communication)
            - name: REDIS_HOST
              value: "redis.redis-system.svc.cluster.local"
            - name: REDIS_PORT
              value: "6379"

          volumeMounts:
            - name: storage
              mountPath: /storage

          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"

      volumes:
        - name: storage
          persistentVolumeClaim:
            claimName: thetagang-storage
